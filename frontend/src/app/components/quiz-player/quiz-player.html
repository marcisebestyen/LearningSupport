<div class="player-layout">
  @if (loading()) {
    <div class="loading">Loading Quiz...</div>
  } @else {

    @if (score() !== null) {
      <div class="result-card">

        <div class="result-header">
          <h1>{{ isReviewMode() ? 'Quiz Results' : 'Quiz Complete!' }}</h1>

          <div class="score-circle" [class.pass]="score()! >= 5">
            {{ score() }} / 10
          </div>

          @if (isReviewMode()) {
            <p class="info-msg">‚ÑπÔ∏è Showing correct answer key.</p>
          }

          @if (!isReviewMode()) {
            @if (score()! >= 5) {
              <p class="success-msg">üéâ Congratulations! You passed!</p>
            } @else {
              <p class="fail-msg">‚ùå You need 5 points to pass. Try again!</p>
            }
          }

          <button class="primary-btn" (click)="backToMenu()">Back to Quizzes</button>
        </div>
        @if (score()! >= 5) {
          <div class="review-section">
            <h3>{{ isReviewMode() ? 'Correct Answer Key' : 'Detailed Review' }}</h3>

            @if (quizData(); as quiz) {
              @for (q of quiz.questions; track q; let i = $index) {

                <div class="review-item">
                  <p class="review-question"><strong>{{ i + 1 }}.</strong> {{ q.question_text }}</p>

                  <div class="review-options">
                    @for (opt of q.options; track opt) {

                      <div class="review-opt"
                           [class.correct-answer]="opt === q.correct_answer"
                           [class.user-wrong]="!isReviewMode() && userAnswers()[i] === opt && opt !== q.correct_answer">

                        {{ opt }}

                        @if (opt === q.correct_answer) {
                          <span>‚úÖ</span>
                        }

                        @if (!isReviewMode() && userAnswers()[i] === opt && opt !== q.correct_answer) {
                          <span>‚ùå</span>
                        }
                      </div>
                    }
                  </div>
                </div>

              }
            }
          </div>
        }
      </div>
    }

    @else {
      @if (quizData(); as quiz) {
        <div class="quiz-container">
          <div class="header">
            <span>Question {{ currentQuestionIndex() + 1 }} / {{ quiz.questions.length }}</span>
            <div class="progress-bar">
              <div class="fill" [style.width.%]="((currentQuestionIndex() + 1) / quiz.questions.length) * 100"></div>
            </div>
          </div>

          <div class="question-card">
            <h2>{{ quiz.questions[currentQuestionIndex()].question_text }}</h2>
            <div class="options-list">
              @for (opt of quiz.questions[currentQuestionIndex()].options; track opt) {
                <button
                  class="option-btn"
                  [class.selected]="userAnswers()[currentQuestionIndex()] === opt"
                  (click)="selectOption(opt)">
                  {{ opt }}
                </button>
              }
            </div>
          </div>

          <div class="controls">
            <button [disabled]="currentQuestionIndex() === 0" (click)="prevQuestion()">Previous</button>
            @if (currentQuestionIndex() === quiz.questions.length - 1) {
              <button class="submit-btn" (click)="submitQuiz()">Submit Quiz</button>
            } @else {
              <button class="next-btn" (click)="nextQuestion()">Next</button>
            }
          </div>
        </div>
      }
    }
  }
</div>
