<div class="history-layout">

  <div class="history-sidebar">
    <div class="sidebar-header">
      <h3>Previous Uploads</h3>
    </div>

    <div class="filter-container">
      <select [(ngModel)]="selectedFilter">
        <option value="ALL">Show All Categories</option>
        @for (cat of categories(); track cat) {
          <option [value]="cat">{{ cat }}</option>
        }
      </select>
    </div>

    <div class="sidebar-list">
      @if (history().length === 0) {
        <p class="empty-msg">No documents found.</p>
      }

      @for (item of filteredHistory(); track item.id) {
        <div class="history-item" [class.selected]="selectedDocId() === item.id" (click)="selectDoc(item)">
          <div class="doc-icon">ğŸ“„</div>
          <div class="doc-info">
            <span class="filename" title="{{item.filename}}">{{ item.filename }}</span>
            <span class="date">{{ item.upload_date | date:'shortDate' }}</span>
          </div>
          <button class="delete-btn" (click)="deleteDoc($event, item)" title="Delete Document">âœ•</button>
        </div>
      }
    </div>
  </div>

  <div class="history-main">

    @if (!selectedDocId()) {
      <div class="placeholder-state">
        <span class="icon">ğŸ‘ˆ</span>
        <p>Select a document from the sidebar.</p>
      </div>
    } @else {

      <div class="main-header">
        <div class="doc-title">
          <h2>{{ selectedFilename() }}</h2>
        </div>

        <div class="view-toggle">
          <button [class.active]="activeTab() === 'summary'" (click)="switchTab('summary')" class="summary-btn">
            ğŸ“„ Summary
          </button>

          <button [class.active]="activeTab() === 'grader'" (click)="switchTab('grader')" class="grader-btn">
            ğŸ“ Submit Essay
          </button>

          <button [class.active]="activeTab() === 'chat'" (click)="switchTab('chat')" class="chat-btn">
            ğŸ’¬ AI Chat
          </button>

          <button [class.active]="activeTab() === 'tutor'" (click)="switchTab('tutor')" class="tutor-btn">
            ğŸ“ Socratic Tutor
          </button>
        </div>
      </div>

      <div class="content-body">

        @if (activeTab() === 'summary') {
          <div class="summary-container fade-in">
            <div class="markdown-body">
              <markdown [data]="selectedSummary()"></markdown>
            </div>

            <div class="action-bar">
              <button (click)="generateAudio()" [disabled]="isGeneratingAudio()">
                @if (isGeneratingAudio()) { <div class="spinner"></div> Creating... }
                @else { <span>ğŸ”‰</span> Generate Audio }
              </button>

              <button (click)="startFlashcards()" [disabled]="isGeneratingCards()">
                @if (isGeneratingCards()) { <div class="spinner"></div> Creating... }
                @else { <span>ğŸ´</span> Generate Flashcards }
              </button>

              <button (click)="generateMindMap()" [disabled]="isGeneratingMindMap()">
                @if (isGeneratingMindMap()) { <div class="spinner"></div> Creating... }
                @else { <span>ğŸ§ </span> Generate Mind Map }
              </button>

              <button (click)="generateQuiz()" [disabled]="isGeneratingQuiz()">
                @if (isGeneratingQuiz()) { <div class="spinner"></div> Generating... }
                @else { <span>âœ¨</span> Generate Quiz }
              </button>
            </div>
          </div>
        }

        @if (activeTab() === 'chat' || activeTab() === 'tutor') {
          <div class="chat-wrapper fade-in">
            @if (activeTab() === 'tutor') {
              <div class="tutor-banner">
                <span>ğŸ“ <b>Socratic Mode:</b> I will ask the questions. You give the answers!</span>
              </div>
            }

            <div class="chat-messages" #scrollContainer>
              @if(chatMessages().length === 0 && !isChatLoading()) {
                <div class="chat-empty">
                  @if(activeTab() === 'tutor') {
                    <p>Starting session...</p>
                  } @else {
                    <p>Ask a question about this document to get started!</p>
                  }
                </div>
              }

              @for (msg of chatMessages(); track $index) {
                <div class="msg-row" [class.user]="msg.role === 'user'">
                  <div class="msg-bubble" [class.status-correct]="msg.status === 'correct'"
                       [class.status-incorrect]="msg.status === 'incorrect'">
                    <div class="sender">
                      {{ msg.role === 'user' ? 'You' : (activeTab() === 'tutor' ? 'Socratic Tutor' : 'AI Assistant') }}
                    </div>
                    <markdown [data]="msg.text"></markdown>
                  </div>
                </div>
              }

              @if (isChatLoading()) {
                <div class="msg-row ai">
                  <div class="msg-bubble loading">
                    <span>Thinking...</span>
                  </div>
                </div>
              }
            </div>

            <div class="chat-input-area">
              <div class="input-box">
                <input [(ngModel)]="chatInput" (keyup.enter)="!sessionFinished() && sendMessage()"
                       [placeholder]="sessionFinished() ? 'Session Finished. Refresh to start over.' : (activeTab() === 'tutor' ? 'Type your answer here...' : 'Ask a question...')"
                       [disabled]="isChatLoading() || sessionFinished()">
                @if (sessionFinished()) {
                  <button class="restart-btn" (click)="restartTutor()">
                    ğŸ”„ Restart
                  </button>
                } @else {
                  <button (click)="sendMessage()" [disabled]="!chatInput() || isChatLoading()">
                    Send
                  </button>
                }
              </div>
            </div>
          </div>
        }

        @if (activeTab() === 'grader') {
          <div class="essay-container fade-in">
            <div class="essay-input-wrapper">

              <div class="header-text" style="text-align:center; margin-bottom: 20px;">
                <h3>Submit Essay for Grading</h3>
                <p style="color:#aaa">Upload your work or type it below. The AI will analyze it against this document.</p>
              </div>

              <div class="mode-toggle">
                <button [class.active]="essayInputMode() === 'type'" (click)="essayInputMode.set('type')">âœï¸ Type Manually</button>
                <button [class.active]="essayInputMode() === 'upload'" (click)="essayInputMode.set('upload')">ğŸ“‚ Upload File</button>
              </div>

              @if (essayInputMode() === 'type') {
                <textarea [(ngModel)]="essayText" placeholder="Write or paste your essay here..."></textarea>
              }

              @if (essayInputMode() === 'upload') {

                @if (!essayFile()) {
                  <div class="drop-zone" appDragDrop (fileDropped)="onFileDropped($event)">
                    <div class="icon">â˜ï¸</div>
                    <h3>Drag & Drop File</h3>
                    <p>PDF or Word (.docx)</p>

                    <label for="essayFileInput" class="browse-btn">Browse Computer</label>
                    <input
                      type="file"
                      id="essayFileInput"
                      (change)="onEssayFileSelected($event)"
                      accept=".pdf, .docx"
                      hidden
                    >
                  </div>
                }

                @else {
                  <div class="file-preview-card fade-in">
                    <div class="file-info">
                      <span class="file-icon">ğŸ“„</span>
                      <div class="file-details">
                        <span class="file-name">{{ essayFile()?.name }}</span>
                        <span class="file-size">{{ (essayFile()?.size || 0) / 1024 | number:'1.0-2' }} KB</span>
                      </div>
                    </div>

                    <button class="remove-file-btn" (click)="removeEssayFile()" [disabled]="isGrading()">
                      âœ• Remove
                    </button>
                  </div>
                }

              }

              <div class="submit-area">
                <button class="grade-btn" (click)="submitEssay()" [disabled]="isGrading()">
                  @if(isGrading()) { <div class="spinner"></div> Grading... }
                  @else { ğŸ“ Grade My Essay }
                </button>
              </div>

            </div>
          </div>
        }
      </div>
    }
  </div>
</div>
